version: "3.5"

networks:
  db_network:
    driver: bridge
    name: ibook_db_access-${VOLUME_MODE:-dev}
    ipam:
      driver: default
    internal: ${INTERNAL_DB:-true}
  backend_network:
    driver: bridge
    name: ibook-backend-network-${VOLUME_MODE:-dev}
    internal: true
  production_network:
    name: ibook_production_proxy
    external: true
#  db_network: {}
#  backend_network: {}
#  production_network: {}


services:

  proxy:
    image: nginxproxy/nginx-proxy:alpine

  acme-proxy:
    image: nginxproxy/acme-companion:latest

  db:
    image: postgres:14-alpine3.14
    command: postgres -c max_connections=50 -c shared_buffers=80MB
    restart: ${RESTART_CONTAINER:-no}

    environment:
      POSTGRES_DB: ${PGDATABASE}
      POSTGRES_USER: ${PG_SUPERUSER_NAME}
      POSTGRES_PASSWORD: ${PG_SUPERUSER_PASSWORD}
      PGDATA: /var/lib/postgresql/data
      VIRTUAL_HOST: ${DB_VIRTUAL_HOST}
      VIRTUAL_PORT: ${PG_HOST_PORT}
    volumes:
      - postrges14_volume:/var/lib/postgresql/data
    networks:
      - db_network
    ports:
      - '${PG_HOST_PORT:-5432}:5432'
    expose:
      - '${PG_HOST_PORT:-5432}'
  
  
  #  complete_migrations:

  backend:
    image: daniinxorchenabo/ibook_backend:${PYTHON_ENV_TAG:-latest}
    networks:
      - production_network
      - backend_network
      - db_network

    restart: ${RESTART_CONTAINER:-no}
    environment:
      LETSENCRYPT_TEST: ${TEST_HTTPS_PROTOCOL:-true}
      PGHOST: db
      VIRTUAL_HOST: ${BACKEND_API_VIRTUAL_HOST}
      VIRTUAL_PORT: ${BACKEND_API_PORT:-5264}
      SSL_TYPE: letsencrypt
      LETSENCRYPT_HOST: ${BACKEND_API_VIRTUAL_HOST}
    depends_on:
      - db

    command: dotnet socialNetworkApp.dll 
    ports:
      - '${EXTERNAL_BACKEND_PORT:-80}:80'
    expose:
      - ${EXTERNAL_BACKEND_PORT:-80}

  pgadmin:
    image: dpage/pgadmin4:5.7
    depends_on:
      - db
    restart: ${RESTART_CONTAINER:-no}

    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
      PGADMIN_LISTEN_PORT: 80
      VIRTUAL_HOST: ${PGADMIN_VIRTUAL_HOST}
      VIRTUAL_PORT: ${PGADMIN_PORT}
    #      VIRTUAL_PROTO: https
    networks:
      - db_network
      - production_network
    ports:
      - '${PGADMIN_PORT}:80'
    expose:
      - '${PGADMIN_PORT}'
    volumes:
      - pgadmin_volume:/var/lib/pgadmin
    links:
      - "db:pgsql-server"

volumes:
  postrges14_volume:
    name: postrges14_volume-${VOLUME_MODE}
  pgadmin_volume:
    name: pgadmin_volume-${VOLUME_MODE}
  front_volume:
    name: ibook_front-${VOLUME_MODE}
